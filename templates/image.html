<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Skin Disease Detection</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script>
			// Load DaisyUI (extends TailwindCSS)
			tailwind.config = {
				plugins: [require('daisyui')],
				daisyui: {
					themes: ['emerald'], // Choose a theme
				},
			}
		</script>
	</head>

	<body class="bg-gray-200 text-gray-800">
		<nav class="bg-gray-100 shadow-sm px-5">
			<div
				class="container mx-auto py-5 flex items-center justify-between md:justify-center space-x-0 md:space-x-32"
			>
				<a
					href="/"
					class="btn btn-sm btn-primary border border-gray-300 py-2 px-3 rounded-lg"
					>Overview</a
				>
				<a href="/" class="">
					<img
						src="/static/logo.png"
						width="48px"
						alt="Skin Disease Detector"
					/>
				</a>
				<a
					href="/image"
					class="btn btn-sm btn-primary border border-gray-300 py-2 px-5 rounded-lg"
					>Model</a
				>
			</div>
		</nav>

		<div class="container mx-auto py-10">
			<h1 class="text-3xl font-bold text-center">Skin Disease Detection</h1>
			<p class="text-center text-sm text-gray-600 mt-2">
				Upload a clear image of the skin lesion for analysis
			</p>
			<div
				class="relative max-w-2xl w-11/12 md:w-full p-5 my-5 mx-auto artboard artboard-horizontal bg-white shadow-lg rounded-lg phone-1"
			>
				<div
					id="processing"
					class="hidden absolute flex items-center justify-center top-0 left-0 w-full h-full bg-white/70 animate-pulse"
				>
					Processing...
				</div>

				<div class="mt-5 space-y-2">
					<form id="captureForm" enctype="multipart/form-data">
						<label
							for="captureInput"
							class="h-24 flex justify-center items-center bg-gray-200 border-2 border-dashed border-gray-400 rounded-lg text-gray-400 font-semibold cursor-pointer hover:bg-gray-300 transition"
						>
							üì∏ Tap to capture photo
						</label>
						<input
							type="file"
							id="captureInput"
							name="image"
							accept="image/*"
							capture="environment"
							class="hidden"
						/>
					</form>
					<form id="uploadForm" enctype="multipart/form-data">
						<label
							for="uploadInput"
							class="h-24 flex justify-center items-center bg-gray-200 border-2 border-dashed border-gray-400 rounded-lg text-gray-400 font-semibold cursor-pointer hover:bg-gray-300 transition"
						>
							üìÅ Click to upload the image
						</label>
						<input
							type="file"
							id="uploadInput"
							name="image"
							accept="image/*"
							class="hidden"
						/>
					</form>
				</div>

				<div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
					<p class="text-xs text-yellow-800">
						<strong>‚ö†Ô∏è Important:</strong> This is a screening tool only. Always
						consult a dermatologist for proper diagnosis and treatment.
					</p>
				</div>
			</div>

			<div
				id="output"
				class="hidden max-w-6xl w-11/12 md:w-full my-5 mx-auto bg-white shadow-lg rounded-lg"
			>
				<div class="md:flex items-stretch p-5 gap-5">
					<!-- Left Side - Input Image -->
					<div class="w-full md:w-1/2 space-y-3">
						<p class="font-bold text-xl text-center text-gray-800">
							Uploaded Image
						</p>
						<img
							id="inputImage"
							src=""
							alt="Input"
							class="w-full rounded-lg border-2 border-gray-300 shadow-md"
						/>
					</div>

					<!-- Right Side - Diagnosis Results -->
					<div class="w-full md:w-1/2 space-y-3 mt-5 md:mt-0">
						<p class="font-bold text-xl text-center text-gray-800">
							Analysis Results
						</p>
						<div
							class="bg-gradient-to-br from-green-50 to-blue-50 border-2 border-green-200 rounded-lg p-5 shadow-md"
						>
							<h3
								class="text-2xl font-bold text-gray-800 mb-4 flex items-center justify-center"
							>
								<svg
									class="w-8 h-8 mr-2 text-green-600"
									fill="none"
									stroke="currentColor"
									viewBox="0 0 24 24"
								>
									<path
										stroke-linecap="round"
										stroke-linejoin="round"
										stroke-width="2"
										d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
									></path>
								</svg>
								Diagnosis
							</h3>
							<div class="space-y-4">
								<div class="bg-white rounded-lg p-5 shadow-sm">
									<p class="text-sm text-gray-600 font-semibold mb-2">
										Detected Condition:
									</p>
									<p
										id="predictionText"
										class="text-3xl font-bold text-gray-900"
									></p>
								</div>
								<div class="bg-white rounded-lg p-5 shadow-sm">
									<p class="text-sm text-gray-600 font-semibold mb-2">
										Confidence Level:
									</p>
									<p
										id="confidenceText"
										class="text-3xl font-bold text-blue-600 mb-3"
									></p>
									<div class="bg-gray-200 rounded-full h-4 overflow-hidden">
										<div
											id="confidenceBar"
											class="bg-gradient-to-r from-blue-500 to-green-500 h-full transition-all duration-500 flex items-center justify-center text-xs text-white font-bold"
											style="width: 0%"
										></div>
									</div>
								</div>
							</div>
							<div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
								<p class="text-xs text-red-700">
									<strong>‚ö†Ô∏è Medical Disclaimer:</strong> This AI analysis is
									for informational purposes only. Always consult a qualified
									dermatologist for proper diagnosis and treatment.
								</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			const captureForm = document.getElementById('captureForm')
			const uploadForm = document.getElementById('uploadForm')

			const captureInput = document.getElementById('captureInput')
			const uploadInput = document.getElementById('uploadInput')

			const inputImage = document.getElementById('inputImage')
			const outputImage = document.getElementById('outputImage')

			const process = async (type) => {
				// show processing
				setLoading(true)

				// clear outputs
				setOutput(false)

				// submit the form
				const formData = new FormData(
					type === 'capture' ? captureForm : uploadForm
				)
				try {
					const res = await submitImg(formData)
					if (res.error) {
						alert(res.error)
						setLoading(false)
						return
					}

					// hide processing
					setLoading(false)

					// show output
					inputImage.src = URL.createObjectURL(
						type === 'capture' ? captureInput.files[0] : uploadInput.files[0]
					)

					// FORCE update prediction results by clearing first
					const predictionElement = document.getElementById('predictionText')
					const confidenceElement = document.getElementById('confidenceText')
					const confidenceBarElement = document.getElementById('confidenceBar')

					// Clear old values first
					predictionElement.textContent = ''
					confidenceElement.textContent = ''
					confidenceBarElement.style.width = '0%'

					// Force a DOM reflow
					void predictionElement.offsetWidth

					// Set new values
					console.log('New prediction:', res.prediction)
					console.log('New confidence:', res.confidence)

					predictionElement.textContent = res.prediction
					confidenceElement.textContent = res.confidence + '%'
					confidenceBarElement.style.width = res.confidence + '%'

					setOutput(true)
				} catch (err) {
					setLoading(false)
					alert(err)
				}
			}

			captureInput.addEventListener('change', async () => process('capture'))
			uploadInput.addEventListener('change', async () => process('upload'))

			const submitImg = async (formData) =>
				await fetch('/process', {
					method: 'POST',
					body: formData,
				})
					.then((res) => res.json())
					.then((data) => data)

			const setLoading = (bool) =>
				bool
					? document.getElementById('processing').classList.remove('hidden')
					: document.getElementById('processing').classList.add('hidden')

			const setOutput = (bool) => {
				if (bool) {
					document.getElementById('output').classList.remove('hidden')
				} else {
					document.getElementById('output').classList.add('hidden')
				}
			}
		</script>
	</body>
</html>
