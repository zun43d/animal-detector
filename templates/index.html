<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Animal Detection</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script>
			// Load DaisyUI (extends TailwindCSS)
			tailwind.config = {
				plugins: [require('daisyui')],
				daisyui: {
					themes: ['emerald'], // Choose a theme
				},
			}
		</script>
	</head>

	<body class="bg-gray-100 text-gray-800">
		<div class="container mx-auto py-10">
			<!-- Page Title -->
			<h1 class="text-4xl font-bold text-center mb-6">Animal Detection</h1>

			<!-- Image and Video Upload Forms -->
			<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
				<!-- Image Upload -->
				<div class="card bg-white shadow-lg p-6 rounded-lg">
					<h2 class="text-2xl font-semibold mb-4">Upload Image</h2>
					<form
						id="imageForm"
						enctype="multipart/form-data"
						class="flex flex-col gap-4"
					>
						<input
							type="file"
							id="image"
							name="image"
							accept="image/*"
							capture="environment"
							class="file-input file-input-bordered w-full"
						/>
						<button
							type="button"
							onclick="processImage()"
							class="btn btn-primary rounded-full p-2 text-white bg-emerald-400 hover:bg-emerald-700 w-1/2 mx-auto"
						>
							Process Image
						</button>
					</form>
				</div>

				<!-- Video Upload -->
				<div class="card bg-white shadow-lg p-6 rounded-lg">
					<h2 class="text-2xl font-semibold mb-4">Upload Video</h2>
					<form
						id="videoForm"
						enctype="multipart/form-data"
						class="flex flex-col gap-4"
					>
						<input
							type="file"
							id="video"
							name="video"
							accept="video/*"
							class="file-input file-input-bordered w-full"
						/>
						<button
							type="button"
							onclick="processVideo()"
							class="btn btn-primary text-white rounded-full p-2 bg-blue-400 hover:bg-blue-700 w-1/2 mx-auto"
						>
							Process Video
						</button>
					</form>
				</div>
			</div>

			<!-- Results Section -->
			<div id="result" class="flex flex-col gap-6">
				<!-- Image Results -->
				<div class="card bg-white shadow-lg p-6 rounded-lg">
					<h2 class="text-2xl font-semibold mb-4">Image Results</h2>
					<div class="flex gap-4">
						<!-- Input Image -->
						<div class="w-1/2">
							<h3 class="text-lg font-semibold mb-2">Input Image</h3>
							<img
								id="inputImage"
								src=""
								alt="Input Image"
								class="w-full h-[400px] border rounded-lg hidden"
							/>
						</div>
						<!-- Output Image -->
						<div class="w-1/2">
							<h3 class="text-lg font-semibold mb-2">Output Image</h3>
							<img
								id="resultImage"
								src=""
								alt="Result Image"
								class="w-full h-[400px] border rounded-lg hidden"
							/>
						</div>
					</div>
				</div>

				<!-- Video Results -->
				<div class="card bg-white shadow-lg p-6 rounded-lg">
					<h2 class="text-2xl font-semibold mb-4">Video Results</h2>
					<div class="flex gap-4">
						<!-- Input Video -->
						<div class="w-1/2">
							<h3 class="text-lg font-semibold mb-2">Input Video</h3>
							<video
								id="inputVideo"
								controls
								class="w-full border h-[400px] rounded-lg hidden"
							></video>
						</div>
						<!-- Output Video -->
						<div class="w-1/2">
							<h3 class="text-lg font-semibold mb-2">Output Video</h3>
							<video
								id="resultVideo"
								controls
								class="w-full border h-[400px] rounded-lg hidden"
							></video>
						</div>
					</div>
				</div>
			</div>
			<!-- Extra Section for Showcasing Media -->
			<div
				class="card bg-white shadow-xl p-6 rounded-lg border border-yellow-300 mt-10"
			>
				<h2 class="text-2xl font-semibold text-yellow-700 mb-4">
					Showcase Uploaded Media
				</h2>
				<div class="flex flex-col gap-4">
					<input
						type="file"
						id="showcaseFile"
						accept="image/*,video/*"
						class="file-input file-input-bordered w-full"
					/>
					<button
						type="button"
						onclick="showcaseMedia()"
						class="btn btn-primary rounded-full p-2 bg-yellow-300 hover:bg-yellow-600 w-1/2 mx-auto"
					>
						Show Media
					</button>
					<div
						id="mediaPreview"
						class="w-full mt-4 flex justify-center items-center"
					>
						<p class="text-gray-600">No media selected yet.</p>
					</div>
				</div>
			</div>
			<!-- Capture Image or Video Section -->
			<div class="card bg-white shadow-lg p-6 rounded-lg">
				<h2 class="text-2xl font-semibold mb-4">Capture Image or Video</h2>
				<input
					type="file"
					id="captureImageInput"
					accept="image/*"
					capture="environment"
					class="file-input file-input-bordered w-full hidden"
					onchange="displayCapturedMedia()"
				/>
				<input
					type="file"
					id="captureVideoInput"
					accept="video/*"
					capture="environment"
					class="file-input file-input-bordered w-full hidden"
					onchange="displayCapturedMedia()"
				/>
				<button
					type="button"
					onclick="document.getElementById('captureImageInput').click()"
					class="btn btn-primary rounded-full p-2 text-white bg-emerald-400 hover:bg-emerald-700 w-1/2 mx-auto"
				>
					Capture Image
				</button>
				<button
					type="button"
					onclick="startVideoRecording()"
					class="btn btn-primary rounded-full p-2 text-white bg-emerald-400 hover:bg-emerald-700 w-1/2 mx-auto"
				>
					Record Video
				</button>
				<div
					id="videoRecordingSection"
					class="w-full mt-4 flex flex-col items-center hidden"
				>
					<video
						id="videoStream"
						class="w-full h-[400px] border rounded-lg"
						autoplay
					></video>
					<button
						id="startStopButton"
						type="button"
						onclick="toggleRecording()"
						class="btn btn-primary rounded-full p-2 text-white bg-red-400 hover:bg-red-700 w-1/2 mx-auto mt-4"
					>
						Start
					</button>
				</div>
				<div
					id="capturedMediaPreview"
					class="w-full mt-4 flex justify-center items-center"
				>
					<video controls playsinline id="videoRecorded"></video>
				</div>
			</div>
		</div>

		<script>
			let mediaRecorder
			let recordedChunks = []

			window.addEventListener('load', async () => {
				try {
					await navigator.mediaDevices.getUserMedia({ video: true })
					console.log('Camera permission granted.')
				} catch (err) {
					console.error('Error accessing camera:', err)
				}
			})

			// Handle Image Processing
			function processImage() {
				const form = document.getElementById('imageForm')
				const formData = new FormData(form)
				const inputImage = document.getElementById('inputImage')
				const resultImage = document.getElementById('resultImage')

				fetch('/process', {
					method: 'POST',
					body: formData,
				})
					.then((response) => response.json())
					.then((data) => {
						if (data.error) {
							alert(data.error)
						} else {
							inputImage.src = URL.createObjectURL(
								document.getElementById('image').files[0]
							)
							inputImage.classList.remove('hidden')
							resultImage.src = data.result_image
							resultImage.classList.remove('hidden')
						}
					})
					.catch((err) => console.error(err))
			}

			// Handle Video Processing
			function processVideo() {
				const form = document.getElementById('videoForm')
				const formData = new FormData(form)
				const inputVideo = document.getElementById('inputVideo')
				const resultVideo = document.getElementById('resultVideo')

				fetch('/process_video', {
					method: 'POST',
					body: formData,
				})
					.then((response) => response.json())
					.then((data) => {
						if (data.error) {
							alert(data.error)
						} else {
							inputVideo.src = URL.createObjectURL(
								document.getElementById('video').files[0]
							)
							inputVideo.classList.remove('hidden')
							resultVideo.src = data.result_video
							resultVideo.classList.remove('hidden')
							resultVideo.load()
						}
					})
					.catch((err) => {
						console.error(err)
						alert('An error occurred while processing the video.')
					})
			}

			function showcaseMedia() {
				const fileInput = document.getElementById('showcaseFile')
				const mediaPreview = document.getElementById('mediaPreview')
				const file = fileInput.files[0]

				if (!file) {
					alert('Please select a file to showcase.')
					return
				}

				mediaPreview.innerHTML = ''
				if (file.type.startsWith('image/')) {
					const img = document.createElement('img')
					img.src = URL.createObjectURL(file)
					img.classList.add(
						'max-w-full',
						'max-h-[400px]',
						'rounded-lg',
						'border'
					)
					mediaPreview.appendChild(img)
				} else if (file.type.startsWith('video/')) {
					const video = document.createElement('video')
					video.src = URL.createObjectURL(file)
					video.controls = true
					video.classList.add(
						'max-w-full',
						'max-h-[400px]',
						'rounded-lg',
						'border'
					)
					mediaPreview.appendChild(video)
				}
			}

			function displayCapturedMedia() {
				const imageInput = document.getElementById('captureImageInput')
				const videoInput = document.getElementById('captureVideoInput')
				const capturedMediaPreview = document.getElementById(
					'capturedMediaPreview'
				)
				const file = imageInput.files[0] || videoInput.files[0]

				if (!file) {
					alert('No media captured.')
					return
				}

				capturedMediaPreview.innerHTML = ''
				if (file.type.startsWith('image/')) {
					const img = document.createElement('img')
					img.src = URL.createObjectURL(file)
					img.classList.add(
						'max-w-full',
						'max-h-[400px]',
						'rounded-lg',
						'border'
					)
					capturedMediaPreview.appendChild(img)
				} else if (file.type.startsWith('video/')) {
					const video = document.createElement('video')
					video.src = URL.createObjectURL(file)
					video.controls = true
					video.classList.add(
						'max-w-full',
						'max-h-[400px]',
						'rounded-lg',
						'border'
					)
					capturedMediaPreview.appendChild(video)
				}
			}

			async function startVideoRecording() {
				const videoRecordingSection = document.getElementById(
					'videoRecordingSection'
				)
				const videoStream = document.getElementById('videoStream')
				const stream = await navigator.mediaDevices.getUserMedia({
					video: {
						height: {
							min: 480,
							ideal: 480,
							max: 720,
						},
						width: {
							min: 640,
							ideal: 640,
							max: 1280,
						},
						facingMode: { exact: 'environment' },
					},
				})
				videoStream.srcObject = stream

				mediaRecorder = new MediaRecorder(stream, {
					// <3>
					mimeType: 'video/webm',
				})

				mediaRecorder.addEventListener('dataavailable', (event) => {
					const videoRecorded = document.getElementById('videoRecorded')
					videoRecorded.src = URL.createObjectURL(event.data) // <6>
				})

				videoRecordingSection.classList.remove('hidden')
			}

			function toggleRecording() {
				const startStopButton = document.getElementById('startStopButton')
				if (startStopButton.innerText === 'Start') {
					startRecording()
					startStopButton.innerText = 'Stop'
				} else {
					stopRecording()
					startStopButton.innerText = 'Start'
				}
			}

			function startRecording() {
				const videoStream = document.getElementById('videoStream')
				const stream = videoStream.srcObject
				// mediaRecorder = new MediaRecorder(stream)
				// mediaRecorder.ondataavailable = handleDataAvailable
				mediaRecorder.start()
				recordedChunks = []
			}

			function stopRecording() {
				mediaRecorder.stop()
				// const videoStream = document.getElementById('videoStream')
				// const stream = videoStream.srcObject
				// stream.getTracks().forEach((track) => track.stop())
				// const blob = new Blob(recordedChunks, { type: 'video/webm' })
				// const videoInput = document.getElementById('captureVideoInput')
				// const file = new File([blob], 'recorded_video.webm', {
				// 	type: 'video/webm',
				// })
				// const dataTransfer = new DataTransfer()
				// dataTransfer.items.add(file)
				// videoInput.files = dataTransfer.files
				// displayCapturedMedia()
			}

			function handleDataAvailable(event) {
				if (event.data.size > 0) {
					recordedChunks.push(event.data)
				}
			}
		</script>
	</body>
</html>
